# Generated by ip6tables-save v1.6.0 on Sat Nov 23 15:56:25 2019
*filter
:INPUT DROP [149:14820]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [1298:143801]
# Allow established connections
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
# Loopback
-A INPUT -i lo -j ACCEPT
# Ping
-A INPUT -p ipv6-icmp -j ACCEPT
# SSH
{% for host in trusted_ipv6_hosts %}
-A INPUT -s {{ host }} -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
{% endfor %}
{% if public_ssh_port %}
# SSH
-A INPUT -d {{ ipv6_address }} -p tcp -m state --state NEW -m tcp --dport {{ public_ssh_port }} -j ACCEPT
{% endif %}
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j DROP
-A INPUT -p tcp -m state --state NEW -m tcp --dport 115 -j DROP


{% if 'dns' in group_names %}
# DNS
-A INPUT -d {{ bind_ipv6 }} -p tcp -m state --state NEW -m tcp --dport 53 -j ACCEPT
-A INPUT -d {{ bind_ipv6 }} -p udp -m state --state NEW -m udp --dport 53 -j ACCEPT
{% endif %}

{% if 'mail'  in group_names %}
# Mail Incoming
-A INPUT -d {{ mail_ipv6 }} -p tcp -m state --state NEW -m tcp --dport 143 -j ACCEPT
-A INPUT -d {{ mail_ipv6 }} -p tcp -m state --state NEW -m tcp --dport 993 -j ACCEPT
# Mail Outgoing
-A INPUT -d {{ mail_ipv6}} -p tcp -m state --state NEW -m tcp --dport 25 -j ACCEPT
-A INPUT -d {{ mail_ipv6 }} -p tcp -m state --state NEW -m tcp --dport 465 -j ACCEPT
-A INPUT -d {{ mail_ipv6 }} -p tcp -m state --state NEW -m tcp --dport 587 -j ACCEPT
#  Don't let anything connect to Amavisd
-A INPUT -p tcp -m multiport --dports 10024,10025,10026 -j DROP
#  LDAP from Home
#-A INPUT -s  -p tcp -m state --state NEW -m tcp --dport 389 -j ACCEPT
# Replication
{% for host in ldap_allow_list %}
{% if hostvars[host]['ipv6_address'] | default(False) %}
-A INPUT -s {{ hostvars[host]['ipv6_address'] }} -p tcp -m multiport --dport 389,636 -j ACCEPT
{% endif %}
{% endfor %}
{% for host in doveadm_allow_list %}
{% if hostvars[host]['ipv6_address'] | default(False) %}
# doveadm
-A INPUT -s {{ hostvars[host]['mail_ipv6'] }}/32 -p tcp -m multiport --dport {{ doveadm_port }} -j ACCEPT
{% endif %}
{% endfor %}
# Deny everyone else
-A INPUT -p tcp -m state --state NEW -m tcp --dport 389 -j DROP
-A INPUT -p tcp -m state --state NEW -m tcp --dport 636 -j DROP
{% endif %}

# Hostname
-A INPUT -d {{ ipv6_address }} -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT
-A INPUT -d {{ ipv6_address }} -p tcp -m state --state NEW -m tcp --dport 443 -j ACCEPT

{% for address in ipv6_websites %}
-A INPUT -d {{ address }} -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT
-A INPUT -d {{ address }} -p tcp -m state --state NEW -m tcp --dport 443 -j ACCEPT
{% endfor %}

COMMIT
