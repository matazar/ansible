# Do we have a backup?
- name: Check for backup copy of database to restore.
  stat: 
    path: "{{ backup_dir }}/ldap/{{ ldap_hostname }}/seed.ldif"
  register: ldap_backup
  
- debug:
    var: ldap_backup.stat.exists

# Restore backups if they exist
- include_tasks: restore.yml
  when: ldap_backup.stat.exists

# This is required during provisioning.
- name: Ensure ldap hostname is in host file.
  lineinfile:
    path: /etc/hosts
    line: "{{ ldap_localip }} {{ ldap_hostname }} {{ ldap_hostname.split('.')[0] }}"

- name: Ensure LDAP is started
  service:
    name: slapd
    state: started

# Unable to properly encrypt during original import.
- name: Set root password
  ldap_attrs:
    dn: olcDatabase={1}mdb,cn=config
    state: exact
    attributes:
      olcRootPW: "{{ ldap_pw | password_hash('ldap_salted_sha1') }}"

  
