- block:
  - name: Ensure IPv6 addresses are configured for boot
    blockinfile:
      path: /etc/network/interfaces
      block: "{% for ip in ipv6_addresses %}iface {{ ansible_default_ipv6['interface'] }} inet6 static\n{{ '\t' }}address {{ ip }}/64\n\n{% endfor %}"
      insertafter: "EOF"

  - set_fact:
      missing_ipv6: "{{ ipv6_addresses | difference(ansible_all_ipv6_addresses) }}"

  - name: "Ensure IPv6 is configured on the host"
    command: "ip -6 addr add {{ item }}/64 dev {{ ansible_default_ipv6['interface'] | default(False) }}"
    loop: "{{ missing_ipv6 }}"
    when: 
      - 'missing_ipv6 | length > 0'
  when: ipv6_address

- name: Update nameservers, if defined
  template:
    src: resolv.conf.j2
    dest: /etc/resolv.conf
  when: local_nameservers != []
  
# Set up WiFi on those in the WiFi group
- name: Configure WLAN
  template:
    src: wpa_supplicant.conf.j2
    dest: /etc/wpa_supplicant/wpa_supplicant.conf
  when: "'wifi' in group_names"
  notify: restart network